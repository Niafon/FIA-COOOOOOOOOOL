var $e=Object.defineProperty;var Ve=(s,e,t)=>e in s?$e(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var h=(s,e,t)=>Ve(s,typeof e!="symbol"?e+"":e,t);import{d as qe,o as Ke,p as pe,q as Je,s as Ye,R as T,Q as Qe,j as a,t as Xe,W as Ze,r as d,v as et,w as ve,x as tt,y as nt,z as st,c as Te,A as at,B as it}from"./web3-core-u9Xui7sV.js";import{a as ot}from"./react-lB9TgwmK.js";import{R as rt,d as ct,u as Me,a as Le,e as lt}from"./rainbowkit-D8RE5pWE.js";import{s as j,u as dt,n as V,e as Pe,o as q,b as Y,a as ke,c as ut,l as ht}from"./utils-DWDzwfiT.js";import{w as me,s as mt,c as wt,a as Re,b as Oe,i as ft}from"./sentry-Bb6USDVD.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();var ee={},ge;function pt(){if(ge)return ee;ge=1;var s=ot();return ee.createRoot=s.createRoot,ee.hydrateRoot=s.hydrateRoot,ee}var De=pt();const b={Empty:"empty",Seed:"seed",Growing:"growing",Ready:"ready"},S={Plant:"plant",Water:"water",Harvest:"harvest"};function we(s){if(!s||s.timerActive&&s.stage!==b.Ready)return null;switch(s.stage){case b.Empty:return S.Plant;case b.Seed:return S.Water;case b.Growing:return S.Harvest;case b.Ready:return S.Harvest;default:return null}}function vt(s){switch(s){case b.Empty:return"🟫";case b.Seed:return"🌱";case b.Growing:return"🌿";case b.Ready:return"🌾";default:return"🟫"}}function gt(s,e){const t=s===b.Empty?"Empty bed":s===b.Seed?"Seed planted":s===b.Growing?"Growing":"Ready to harvest",n=e?`, next action ${e}`:"";return`${t}${n}`}function yt(s,e){let t=0,n=null,i=null;const r=()=>{t=Date.now(),i&&s.apply(null,i),n=null,i=null};return(...c)=>{const o=Date.now(),l=e-(o-t);i=c,l<=0||l>e?(n&&(clearTimeout(n),n=null),r()):n||(n=window.setTimeout(r,l))}}function St(s,e){let t=0,n=0;return function(){const r=Date.now();return r-n<e||t>=s?!1:(n=r,t++,setTimeout(()=>t--,6e4),!0)}}const ie=j().regex(/^0x[a-fA-F0-9]{40}$/,"Invalid Ethereum address"),We=dt([j().regex(/^0x[a-fA-F0-9]+$/,"Invalid hex chain ID"),j().regex(/^\d+$/,"Invalid decimal chain ID"),V().positive("Chain ID must be positive")]);j().regex(/^0x[a-fA-F0-9]{64}$/,"Invalid transaction hash");const bt=V().int().min(0).max(5,"Bed index out of range"),xt=V().int().positive().refine(s=>s%10===0,"Wheat amount must be multiple of 10"),Et=Pe(["empty","seed","growing","ready"]),Ct=q({stage:Et,nextAction:Pe(["plant","water","harvest"]).nullable(),timerActive:Y(),timerEnd:V().optional()}),Bt=q({wheat:V().int().min(0),coins:V().int().min(0)});q({beds:ke(Ct),inventory:Bt,firstTime:Y(),expansionPurchased:Y(),wellPurchased:Y(),fertilizerPurchased:Y()});q({address:ie,functionName:j().min(1,"Function name required"),args:ke(ut()).optional()});q({domain:j().min(1,"Domain required"),address:ie,uri:j().url("Invalid URI"),chainId:We,nonce:j().min(8,"Nonce too short"),statement:j().optional(),version:ht("1"),issuedAt:j().datetime().optional(),expirationTime:j().datetime().optional()});const It=q({VITE_CONTRACT_ADDRESS:ie,VITE_MONAD_CHAIN_ID:We.default("10143"),VITE_MONAD_RPC_URL:j().url().default("https://testnet-rpc.monad.xyz"),VITE_MONAD_CHAIN_NAME:j().default("Monad Testnet"),VITE_WALLETCONNECT_PROJECT_ID:j().optional(),VITE_SENTRY_DSN:j().url().optional()});function _t(s){return ie.safeParse(s)}function fe(s){return bt.safeParse(s)}function At(s){return xt.safeParse(s)}function jt(s){return It.safeParse(s)}const le=jt({VITE_CONTRACT_ADDRESS:void 0,VITE_MONAD_CHAIN_ID:void 0,VITE_MONAD_RPC_URL:void 0,VITE_MONAD_CHAIN_NAME:void 0,VITE_WALLETCONNECT_PROJECT_ID:void 0,VITE_SENTRY_DSN:void 0});le.success;const Z=le.success?le.data:{VITE_CONTRACT_ADDRESS:"",VITE_MONAD_CHAIN_ID:"10143",VITE_MONAD_RPC_URL:"https://testnet-rpc.monad.xyz",VITE_MONAD_CHAIN_NAME:"Monad Testnet",VITE_SENTRY_DSN:void 0},Nt=Z.VITE_CONTRACT_ADDRESS,L=Z.VITE_MONAD_CHAIN_ID,He=Z.VITE_MONAD_RPC_URL,Ue=Z.VITE_MONAD_CHAIN_NAME;Z.VITE_SENTRY_DSN;const Q="".split(",").map(s=>s.trim()).filter(Boolean).length>0?(void 0).split(",").map(s=>s.trim()).filter(Boolean):[He];function Tt(){const s=(Nt||"").trim();if(!s)throw new Error("Contract address is not configured. Set VITE_CONTRACT_ADDRESS in .env");return s}function Mt(){const s=(L||"").toString();return s?s.startsWith("0x")?parseInt(s,16):parseInt(s,10):0}const de=qe({id:Mt(),name:Ue||"Monad",nativeCurrency:{name:"MON",symbol:"MON",decimals:18},rpcUrls:{default:{http:Q},public:{http:Q}},testnet:!0}),Lt=Q.length>1?Ke(Q.map(s=>pe(s,{batch:!0,timeout:1e4})),{rank:!1,retryCount:2}):pe(Q[0],{batch:!0,timeout:1e4}),F=Je({chains:[de],connectors:[Ye({shimDisconnect:!0})],transports:{[de.id]:Lt},multiInjectedProviderDiscovery:!0,ssr:!1});function Pt({children:s}){const[e]=T.useState(()=>new Qe({defaultOptions:{queries:{staleTime:3e4,gcTime:3e5,refetchOnWindowFocus:!1,retry:t=>t<2}}}));return T.useEffect(()=>{},[e]),a.jsx(Xe,{client:e,children:a.jsx(Ze,{config:F,children:a.jsx(d.Suspense,{fallback:null,children:a.jsx(rt,{theme:ct({borderRadius:"medium"}),modalSize:"compact",initialChain:de,children:s})})})})}const kt=["function setGameState(string state)","function getGameState(address player) view returns (string)","function plant(uint256 bedIndex)","function water(uint256 bedIndex)","function harvest(uint256 bedIndex)","function batchPlant(uint256[] bedIndices)","function batchWater(uint256[] bedIndices)","function batchHarvest(uint256[] bedIndices)","function exchangeWheat(uint256 wheatAmount)","function buyExpansion()","function buyWell()","function buyFertilizer()","function getFullState(address player) view returns (string)","function pause()","function unpause()","function paused() view returns (bool)","event StateDelta(address indexed player)"],se=et(kt);function Ge(){return Tt()}const oe=new Map,re=new Map;async function Rt(s){const e=_t(s);if(!e.success)throw new Error(`Invalid player address: ${e.error.message}`);const t=Ge(),n=`readFullState:${t}:${s.toLowerCase()}`,i=Date.now(),r=oe.get(n);if(r&&r.expiresAt>i)return r.value;const c=re.get(n);if(c)return c;const o=(async()=>{try{const l=await ve(F,{address:t,abi:se,functionName:"getFullState",args:[s]});return oe.set(n,{value:l,expiresAt:i+1500}),l}catch{const l=await ve(F,{address:t,abi:se,functionName:"getGameState",args:[s]});return oe.set(n,{value:l,expiresAt:i+1500}),l}finally{re.delete(n)}})();return re.set(n,o),o}async function U(s,e){const t=Ge();await tt(F,{address:t,abi:se,functionName:s,args:e});const n=await nt(F,{address:t,abi:se,functionName:s,args:e});return await st(F,{hash:n})}async function Ot(s){return U("setGameState",[s])}async function ye(s){const e=fe(s);if(!e.success)throw new Error(`Invalid bed index: ${e.error.message}`);const t=[BigInt(s)];return U("plant",t)}async function Se(s){const e=fe(s);if(!e.success)throw new Error(`Invalid bed index: ${e.error.message}`);const t=[BigInt(s)];return U("water",t)}async function be(s){const e=fe(s);if(!e.success)throw new Error(`Invalid bed index: ${e.error.message}`);const t=[BigInt(s)];return U("harvest",t)}async function Dt(s){const e=At(s);if(!e.success)throw new Error(`Invalid wheat amount: ${e.error.message}`);const t=[BigInt(s)];return U("exchangeWheat",t)}async function Wt(){return U("buyExpansion",[])}async function Ht(){return U("buyWell",[])}async function Ut(){return U("buyFertilizer",[])}class Gt{constructor(){h(this,"inflight",new Map)}run(e,t){const n=this.inflight.get(e);if(n)return n;const i=t().finally(()=>{this.inflight.get(e)===i&&this.inflight.delete(e)});return this.inflight.set(e,i),i}}async function zt(s,e){const t=e==null?void 0:e.retries,n=e==null?void 0:e.baseMs;let i=0;for(;;)try{return await s()}catch(r){if(i>=t)throw r;const c=Math.floor(Math.random()*100),o=n*2**i+c;await new Promise(l=>setTimeout(l,o)),i++}}function Ft({index:s}){const[e,t]=d.useState(()=>{var o,l;return(l=(o=window.gameBridge)==null?void 0:o.getBed)==null?void 0:l.call(o,s)});d.useEffect(()=>{const o=l=>{var w;const u=l;((w=u.detail)==null?void 0:w.index)===s&&t(u.detail.bed)};return window.addEventListener("bed:update",o),()=>window.removeEventListener("bed:update",o)},[s]);const n=d.useMemo(()=>we(e),[e]),i=d.useMemo(()=>!e||!n||e.isActionInProgress?!1:e.stage===b.Ready?!0:!e.timerActive,[e,n]),r=d.useCallback(()=>{var l,u,w,f,m,p,v;if(!((w=(u=(l=window.walletBridge)==null?void 0:l.getState)==null?void 0:u.call(l))==null?void 0:w.address)){try{(m=(f=window.gameBridge)==null?void 0:f.showToast)==null||m.call(f,"Connect wallet to use this feature")}catch{}return}i&&((v=(p=window.gameBridge)==null?void 0:p.performAction)==null||v.call(p,s))},[s,i]),c=o=>{(o.key==="Enter"||o.key===" ")&&i&&(o.preventDefault(),r())};return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"bed-ascii",children:`+----------------------------+
|                            |
|         garden bed         |
|                            |
|                            |
|                            |
|                            |
|                            |
+----------------------------+`}),a.jsx("div",{className:"plant",role:"button",tabIndex:0,"aria-label":gt((e==null?void 0:e.stage)??b.Empty,n),onClick:r,onKeyDown:c,children:vt((e==null?void 0:e.stage)??b.Empty)})]})}const $t=T.memo(Ft);function Vt(s){switch(s){case S.Plant:return"🌰";case S.Water:return"💧";case S.Harvest:return"🧺";default:return""}}function qt({index:s}){const[e,t]=d.useState(()=>{var c,o;return(o=(c=window.gameBridge)==null?void 0:c.getBed)==null?void 0:o.call(c,s)});d.useEffect(()=>{const c=o=>{var u;const l=o;((u=l.detail)==null?void 0:u.index)===s&&t(l.detail.bed)};return window.addEventListener("bed:update",c),()=>window.removeEventListener("bed:update",c)},[s]);const n=d.useMemo(()=>we(e),[e]);if(!n)return null;const i=c=>{var l,u,w,f,m,p,v;if(c.stopPropagation(),!((w=(u=(l=window.walletBridge)==null?void 0:l.getState)==null?void 0:u.call(l))==null?void 0:w.address)){try{(m=(f=window.gameBridge)==null?void 0:f.showToast)==null||m.call(f,"Connect wallet to use this feature")}catch{}return}(v=(p=window.gameBridge)==null?void 0:p.performAction)==null||v.call(p,s)},r=c=>{var o,l,u,w,f,m,p;if(c.key==="Enter"||c.key===" "){if(c.preventDefault(),c.stopPropagation(),!((u=(l=(o=window.walletBridge)==null?void 0:o.getState)==null?void 0:l.call(o))==null?void 0:u.address)){try{(f=(w=window.gameBridge)==null?void 0:w.showToast)==null||f.call(w,"Connect wallet to use this feature")}catch{}return}(p=(m=window.gameBridge)==null?void 0:m.performAction)==null||p.call(m,s)}};return a.jsx("div",{className:"action-icon",role:"button",tabIndex:0,"aria-label":n===S.Plant?"Plant seed":n===S.Water?"Water plant":"Harvest crop",onClick:i,onKeyDown:r,children:Vt(n)})}function Kt(s){return Math.max(0,s-Date.now())}function Jt(s){const e=Math.floor(s/1e3),t=Math.floor(e/3600),n=Math.floor(e%3600/60),i=e%60;return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}function Yt({index:s}){const[e,t]=d.useState(void 0),[n,i]=d.useState(!1);d.useEffect(()=>{var w,f;const l=m=>{var y;const p=m;if(((y=p.detail)==null?void 0:y.index)!==s)return;const v=p.detail.bed;v!=null&&v.timerActive&&typeof v.timerEnd=="number"?t(v.timerEnd):t(void 0)};window.addEventListener("bed:update",l);const u=(f=(w=window.gameBridge)==null?void 0:w.getBed)==null?void 0:f.call(w,s);return u!=null&&u.timerActive&&typeof u.timerEnd=="number"&&t(u.timerEnd),()=>window.removeEventListener("bed:update",l)},[s]);const[r,c]=d.useState(()=>Date.now());d.useEffect(()=>{if(!e)return;const l=setInterval(()=>c(Date.now()),500);return()=>clearInterval(l)},[e]);const o=d.useMemo(()=>e?Jt(Kt(e)):"",[e,r]);return d.useEffect(()=>{if(e&&r>=e&&!n){i(!0);const l=new CustomEvent("timer:end",{detail:{index:s}});window.dispatchEvent(l)}},[r,e,n,s]),e?a.jsx("div",{className:"timer","aria-live":"polite",children:o}):null}const Qt=T.memo(Yt);function Xt({index:s}){const[e,t]=d.useState(!1),[n,i]=d.useState(!1);return d.useEffect(()=>{const r=c=>{var u;const o=c;if(((u=o.detail)==null?void 0:u.index)!==s)return;if(o.detail.bed.isActionInProgress)t(!0),i(!1);else if(e){t(!1),i(!0);const w=setTimeout(()=>i(!1),1200);return()=>clearTimeout(w)}};return window.addEventListener("bed:update",r),()=>window.removeEventListener("bed:update",r)},[s,e]),e?a.jsx("div",{className:"tx-status","aria-live":"polite",children:"⏳ Pending"}):n?a.jsx("div",{className:"tx-status","aria-live":"polite",children:"✅ Confirmed"}):null}const Zt=T.memo(Xt);function en({index:s}){const[e,t]=d.useState(null);if(d.useEffect(()=>{const r=c=>{var u;const o=c;if(((u=o.detail)==null?void 0:u.index)!==s)return;t(o.detail.action);const l=setTimeout(()=>t(null),1e3);return()=>clearTimeout(l)};return window.addEventListener("action:animate",r),()=>window.removeEventListener("action:animate",r)},[s]),!e)return null;const n=e==="plant"?"action-animation seed-animation":e==="water"?"action-animation water-animation":"action-animation harvest-animation",i=e==="plant"?"🌰":e==="water"?"💧":"🔪";return a.jsx("div",{className:n,children:i})}function tn({index:s}){var v,y,B,P;const[e,t]=d.useState(()=>{var x,I;return(I=(x=window.gameBridge)==null?void 0:x.getBed)==null?void 0:I.call(x,s)}),[n,i]=d.useState(!1),[r,c]=d.useState({}),o=!!((B=(y=(v=window.walletBridge)==null?void 0:v.getState)==null?void 0:y.call(v))!=null&&B.address);d.useEffect(()=>{var M,G;const x=K=>{var _;const g=K;((_=g.detail)==null?void 0:_.index)===s&&t(g.detail.bed)},I=K=>{c({...K.detail||{}})};window.addEventListener("bed:update",x),window.addEventListener("inventory:update",I);const $=((G=(M=window.gameBridge)==null?void 0:M.getInventory)==null?void 0:G.call(M))||{};return c({...$}),()=>{window.removeEventListener("bed:update",x),window.removeEventListener("inventory:update",I)}},[s]);const l=!o||(e==null?void 0:e.stage)!=="empty",u=[{key:"wheat",emoji:"🌾",name:"Wheat"},...r.seed_tomato>0?[{key:"tomato",emoji:"🍅",name:"Tomato"}]:[],...r.seed_cucumber>0?[{key:"cucumber",emoji:"🥒",name:"Cucumber"}]:[],...r.seed_hops>0?[{key:"hops",emoji:"🌿",name:"Hops"}]:[]],w=x=>{i(!1);try{const I=new CustomEvent("bed:setCrop",{detail:{index:s,crop:x}});window.dispatchEvent(I)}catch{}},f=()=>{l||i(!n)},m=(e==null?void 0:e.crop)||"wheat",p=((P=u.find(x=>x.key===m))==null?void 0:P.emoji)||"🌾";return l?null:a.jsxs("div",{className:"crop-selector",children:[a.jsxs("button",{className:"crop-selector-btn",onClick:f,"aria-label":"Select crop type",children:[a.jsx("span",{className:"current-crop",children:p}),a.jsx("span",{className:"arrow",children:"⌄"})]}),n&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"crop-menu-backdrop",onClick:()=>i(!1)}),a.jsx("div",{className:"crop-menu",children:u.map(x=>a.jsxs("button",{className:`crop-option ${x.key===m?"selected":""}`,onClick:()=>w(x.key),children:[a.jsx("span",{className:"crop-emoji",children:x.emoji}),a.jsx("span",{className:"crop-name",children:x.name}),x.key===m&&a.jsx("span",{className:"check",children:"✓"})]},x.key))})]})]})}function nn({index:s}){return a.jsxs("div",{className:"bed-overlay",children:[a.jsx("div",{className:"bed-left",children:a.jsx(Zt,{index:s})}),a.jsxs("div",{className:"bed-center",children:[a.jsx(qt,{index:s}),a.jsx(Qt,{index:s})]}),a.jsx("div",{className:"bed-right",children:a.jsx(tn,{index:s})}),a.jsx(en,{index:s})]})}const sn=T.memo(nn);function an({index:s}){return a.jsxs("div",{className:"garden-bed",id:`bed-${s}`,children:[a.jsx($t,{index:s}),a.jsx("div",{id:`react-action-${s}`,children:a.jsx(sn,{index:s})})]})}const on=T.memo(an),rn=3,cn=500,ln=30;let te=null;function dn(){const s=()=>(te||(te=new un),te);return document.readyState==="loading"?document.addEventListener("DOMContentLoaded",s):s(),te}class un{constructor(){h(this,"gameState");h(this,"contract");h(this,"onStateDeltaHandler");h(this,"useOnChainActions",!0);h(this,"lastToggleTs",0);h(this,"toggleCooldownMs",2500);h(this,"gardenBedsContainer");h(this,"welcomeModal");h(this,"startGameBtn");h(this,"exchangeButton");h(this,"expansionButton");h(this,"buyTomatoSeedBtn");h(this,"buyCucumberSeedBtn");h(this,"buyHopsSeedBtn");h(this,"buyBrewMachineBtn");h(this,"sellTomatoBtn");h(this,"sellCucumberBtn");h(this,"buyWellButton");h(this,"buyFertilizerButton");h(this,"walletButton");h(this,"allowAction",St(ln,cn));h(this,"isProcessingAction",!1);h(this,"boundHandleScroll");h(this,"boundGenerateWaves");h(this,"boundExchangeWheat");h(this,"boundBuyExpansion");h(this,"boundConnectWallet");h(this,"throttledResize");h(this,"lastChainSaveMs",0);h(this,"chainSaveCooldownMs",12e4);h(this,"lastFocusedElement",null);h(this,"modalKeydownHandler");h(this,"bedsUseReact",!1);h(this,"bedsInitialized",!1);h(this,"stateCoalescer",new Gt);h(this,"pollIntervalId");h(this,"checkRateLimit",()=>this.allowAction());h(this,"initializeGardenBeds",()=>{if(this.bedsInitialized&&this.bedsUseReact){this.gameState.beds.forEach((e,t)=>this.emitBedUpdate(t));return}this.gardenBedsContainer.innerHTML="",this.gameState.beds.forEach((e,t)=>{const n=document.createElement("div");this.gardenBedsContainer.appendChild(n),De.createRoot(n).render(T.createElement(on,{index:t})),this.bedsUseReact=!0,this.emitBedUpdate(t)}),this.bedsInitialized=!0});h(this,"updateBed",e=>{document.getElementById(`bed-${e}`)&&this.emitBedUpdate(e)});h(this,"performAction",async(e,t)=>{var r,c;const n=window.walletBridge;if(!(((c=(r=n==null?void 0:n.getState)==null?void 0:r.call(n))==null?void 0:c.address)??this.gameState.walletAddress)){this.showToast("Connect wallet to use this feature");return}if(!(this.isProcessingAction||!this.checkRateLimit()))try{this.isProcessingAction=!0;const o=parseInt(e.split("-")[1]);if(isNaN(o)||!this.deriveNextAction(t)||t.isActionInProgress)return;await this.retryOperation(async()=>{this.gameState.beds[o].isActionInProgress=!0;const u=async()=>{if(this.useOnChainActions){if(!this.gameState.walletAddress){this.showCustomModal("Connect wallet first");return}let f=!1;const m=this.deriveNextAction(this.gameState.beds[o]);if(!m)return;switch(m){case S.Plant:await ye(o),f=!0;break;case S.Water:await Se(o),f=!0;break;case S.Harvest:await be(o),f=!0;break}if(!f)return;await this.loadGameStateOnChain(),this.saveGameState(),this.updateBed(o),this.updateInventory()}else{switch(t.nextAction){case S.Plant:this.gameState.beds[o].stage=b.Seed,this.gameState.beds[o].nextAction=null,this.gameState.beds[o].timerActive=!0,this.gameState.beds[o].timerEnd=Date.now()+10*1e3;break;case S.Water:this.gameState.beds[o].stage=b.Growing,this.gameState.beds[o].nextAction=null,this.gameState.beds[o].timerActive=!0,this.gameState.beds[o].timerEnd=Date.now()+10*1e3;break;case S.Harvest:this.gameState.beds[o].stage=b.Empty,this.gameState.beds[o].nextAction=S.Plant,this.gameState.beds[o].timerActive=!1,this.gameState.inventory.wheat||(this.gameState.inventory.wheat=0),this.gameState.inventory.wheat+=1;break}this.saveGameState(),this.updateBed(o),this.updateInventory()}};let w=this.deriveNextAction(t);setTimeout(()=>{(async()=>{try{await(async()=>{if(this.useOnChainActions){if(!w)return;if(w===S.Harvest){await this.loadGameStateOnChain();const m=this.gameState.beds[o];if(!(m.stage===b.Ready&&!m.timerActive))throw new Error("Not ready to harvest yet")}let f=!1;switch(w){case S.Plant:await ye(o),f=!0;break;case S.Water:await Se(o),f=!0;break;case S.Harvest:await be(o),f=!0;break}if(this.gameState.beds[o].isActionInProgress=!0,this.emitBedUpdate(o),!f)return;await this.loadGameStateOnChain(),this.saveGameState(),(w===S.Plant||w===S.Water)&&(this.gameState.beds[o].timerActive=!0,this.gameState.beds[o].timerEnd=Date.now()+10*1e3),this.updateInventory(),this.emitBedUpdate(o),w=this.deriveNextAction(this.gameState.beds[o])}else await u()})()}catch(f){const m=(f==null?void 0:f.message)||"Transaction failed";(/Not ready to harvest/i.test(m)||/cannot harvest/i.test(m))&&this.showCustomModal("Crop is not ready yet. Please wait a bit more."),this.gameState.beds[o].isActionInProgress&&(this.gameState.beds[o].isActionInProgress=!1,this.gameState.beds[o].timerActive=!1,this.gameState.beds[o].timerEnd=void 0),await this.loadGameStateOnChain(),this.saveGameState(),this.updateInventory(),this.emitBedUpdate(o)}})()},300)})}catch{this.showCustomModal("Action failed. Please try again.")}finally{this.isProcessingAction=!1}});h(this,"updateInventory",()=>{const e=new CustomEvent("inventory:update",{detail:{...this.gameState.inventory}});window.dispatchEvent(e)});h(this,"loadGameState",()=>{let e=!0;try{const t=localStorage.getItem("farmGameAsciiEmojiState");if(t){const n=JSON.parse(t);typeof n.firstTime=="boolean"&&(e=n.firstTime)}}catch{}return{beds:[{stage:b.Empty,nextAction:S.Plant,timerActive:!1,crop:"wheat"},{stage:b.Empty,nextAction:S.Plant,timerActive:!1,crop:"wheat"},{stage:b.Empty,nextAction:S.Plant,timerActive:!1,crop:"wheat"}],inventory:{},firstTime:e,expansionPurchased:!1}});h(this,"saveGameState",()=>{if(!this.gameState.walletAddress){const e={firstTime:this.gameState.firstTime};localStorage.setItem("farmGameAsciiEmojiState",JSON.stringify(e))}this.useOnChainActions||this.maybeSaveGameStateOnChain()});h(this,"exchangeWheat",async()=>{const e=this.gameState.inventory.wheat||0;if(e<10){this.showCustomModal("Not enough wheat to trade");return}if(this.useOnChainActions){if(!this.gameState.walletAddress){this.showCustomModal("Connect wallet first");return}try{const t=Math.floor(e/10);await Dt(t*10),await this.loadGameStateOnChain(),this.saveGameState(),this.updateInventory(),this.showCustomModal(`You traded ${t*10} wheat for ${t} coin(s)!`)}catch(t){const n=(t==null?void 0:t.message)||"";/not enough wheat/i.test(n)?this.showCustomModal("Not enough wheat on-chain. Harvest more first."):this.showCustomModal("Exchange failed")}}else{const t=Math.floor(e/10),n=t;this.gameState.inventory.wheat-=t*10,this.gameState.inventory.coins||(this.gameState.inventory.coins=0),this.gameState.inventory.coins+=n,this.showCustomModal(`You traded ${t*10} wheat for ${n} coin(s)!`),this.saveGameState(),this.updateInventory()}});h(this,"buySeeds",(e,t)=>{if(!this.gameState.walletAddress){this.showCustomModal("Connect wallet first");return}this.ensureCoins(t)&&(this.subItem("coins",t),this.addItem(e,1),this.saveGameState(),this.updateInventory(),this.showCustomModal("Seeds purchased! Choose a bed and set crop, then Plant."))});h(this,"buyBrewingMachine",()=>{if(this.gameState.brewingMachinePurchased){this.showCustomModal("Brewing machine already purchased.");return}if(!this.gameState.walletAddress){this.showCustomModal("Connect wallet first");return}const e=150;this.ensureCoins(e)&&(this.subItem("coins",e),this.gameState.brewingMachinePurchased=!0,this.saveGameState(),this.updateInventory(),this.spawnBrewingMachine(),this.showCustomModal("Brewing machine installed near empty space!"))});h(this,"sellItem",(e,t)=>{if(!this.gameState.walletAddress){this.showCustomModal("Connect wallet first");return}if((this.gameState.inventory[e]||0)<=0){this.showCustomModal(`No ${e}s to sell`);return}this.subItem(e,1),this.addItem("coins",t),this.saveGameState(),this.updateInventory(),this.showCustomModal(`Sold 1 ${e} for ${t} coins`)});h(this,"brewBeer",()=>{if(!this.gameState.walletAddress){this.showCustomModal("Connect wallet first");return}if(!this.gameState.brewingMachinePurchased){this.showCustomModal("Buy brewing machine first");return}if((this.gameState.inventory.hops||0)<5){this.showCustomModal("Need 5 hops to brew 1 beer");return}this.subItem("hops",5),this.addItem("beer",1),this.saveGameState(),this.updateInventory(),this.showCustomModal("Brewed 1 beer 🍺 from 5 hops")});h(this,"buyExpansion",async()=>{if(this.gameState.expansionPurchased){this.showCustomModal("Expansion already purchased.");return}if(this.useOnChainActions){if(!this.gameState.walletAddress){this.showCustomModal("Connect wallet first");return}try{await Wt(),await this.loadGameStateOnChain(),this.saveGameState(),this.initializeGardenBeds(),this.updateInventory(),this.expansionButton.textContent="Expansion sold out",this.expansionButton.disabled=!0,this.showCustomModal("Expansion purchased! New beds added.")}catch{this.showCustomModal("Buy expansion failed")}}else{if(!this.gameState.inventory.coins||this.gameState.inventory.coins<100){this.showCustomModal("Not enough coins to buy expansion.");return}this.gameState.inventory.coins-=100,this.gameState.expansionPurchased=!0;for(let e=0;e<3;e++)this.gameState.beds.unshift({stage:b.Empty,nextAction:S.Plant,timerActive:!1});this.saveGameState(),this.initializeGardenBeds(),this.updateInventory(),this.expansionButton.textContent="Expansion sold out",this.expansionButton.disabled=!0,this.showCustomModal("Expansion purchased! New beds added.")}});h(this,"buyWell",async()=>{if(this.useOnChainActions){if(!this.gameState.walletAddress){this.showCustomModal("Connect wallet first");return}try{await Ht(),await this.loadGameStateOnChain(),this.saveGameState(),this.updateInventory(),this.showCustomModal("Well purchased! Watering is now 2x faster."),this.spawnAsciiWell()}catch{this.showCustomModal("Buy well failed")}}else this.showCustomModal("Well purchase requires wallet connection.")});h(this,"buyFertilizer",async()=>{if(this.useOnChainActions){if(!this.gameState.walletAddress){this.showCustomModal("Connect wallet first");return}try{await Ut(),await this.loadGameStateOnChain(),this.saveGameState(),this.updateInventory(),this.showCustomModal("Fertilizer purchased! Harvest yield doubled."),this.spawnAsciiFertilizer()}catch{this.showCustomModal("Buy fertilizer failed")}}else this.showCustomModal("Fertilizer purchase requires wallet connection.")});h(this,"showCustomModal",(e,t="OK",n)=>{const i=document.getElementById("custom-modal"),r=document.getElementById("custom-modal-message"),c=document.getElementById("custom-modal-button");r&&(r.textContent=e),c&&(c.textContent=t),i&&(i.classList.add("open"),i.setAttribute("aria-hidden","false"),this.lastFocusedElement=document.activeElement||null),c&&(c.setAttribute("aria-label","Close dialog"),c.focus()),this.modalKeydownHandler=o=>{o.key==="Escape"?(o.preventDefault(),i&&i.classList.remove("open"),i==null||i.setAttribute("aria-hidden","true"),this.lastFocusedElement&&(this.lastFocusedElement.focus(),this.lastFocusedElement=null),this.modalKeydownHandler&&(document.removeEventListener("keydown",this.modalKeydownHandler),this.modalKeydownHandler=void 0),n&&n()):o.key==="Tab"&&c&&(o.preventDefault(),c.focus())},document.addEventListener("keydown",this.modalKeydownHandler),c&&(c.onclick=()=>{i&&i.classList.remove("open"),i==null||i.setAttribute("aria-hidden","true"),this.modalKeydownHandler&&(document.removeEventListener("keydown",this.modalKeydownHandler),this.modalKeydownHandler=void 0),this.lastFocusedElement&&(this.lastFocusedElement.focus(),this.lastFocusedElement=null),n&&n()})});h(this,"connectWallet",async()=>{try{const e=new CustomEvent("wallet:openConnect");window.dispatchEvent(e)}catch{}});h(this,"loadGameStateOnChain",async()=>{if(this.gameState.walletAddress)try{const e=await this.stateCoalescer.run("fullState",async()=>await zt(async()=>{const t=this.gameState.walletAddress;return await Rt(t)},{retries:3,baseMs:400}));if(e){const t=JSON.parse(e),n=this.gameState.walletAddress;this.gameState={beds:Array.isArray(t.beds)&&t.beds.length>0?t.beds:[{stage:b.Empty,nextAction:S.Plant,timerActive:!1},{stage:b.Empty,nextAction:S.Plant,timerActive:!1},{stage:b.Empty,nextAction:S.Plant,timerActive:!1}],inventory:t.inventory||{},firstTime:!1,expansionPurchased:!!t.expansionPurchased,walletAddress:n},this.initializeGardenBeds(),this.updateInventory()}}catch{}});h(this,"maybeSaveGameStateOnChain",async()=>{if(!this.gameState.walletAddress)return;const e=Date.now();if(!(e-this.lastChainSaveMs<this.chainSaveCooldownMs))try{const t=JSON.stringify(this.gameState);await this.retryOperation(()=>Ot(t)),this.lastChainSaveMs=e}catch{}});h(this,"setupToggleModule",(e,t,n)=>{const i=document.querySelector(e),r=document.querySelector(t);!i||!r||i.addEventListener("click",c=>{var u,w;const o=window.walletBridge;if(!!!((w=(u=o==null?void 0:o.getState)==null?void 0:u.call(o))!=null&&w.address||this.gameState.walletAddress)){c.preventDefault(),c.stopPropagation(),this.showToast("Connect wallet to use this feature");return}r.classList.toggle("open")})});h(this,"setupInventoryModule",()=>{this.setupToggleModule("#inventory-toggle","#inventory-panel","inventory")});h(this,"setupShopModule",()=>{this.setupToggleModule("#shop-toggle","#shop-panel","shop")});h(this,"disconnectWallet",()=>{var e,t,n,i;try{if(this.contract)try{this.onStateDeltaHandler&&((t=(e=this.contract).off)==null||t.call(e,"StateDelta",this.onStateDeltaHandler)),(i=(n=this.contract).removeAllListeners)==null||i.call(n,"StateDelta")}catch{}}finally{this.contract=void 0,this.gameState.walletAddress=void 0,this.gameState.beds=[{stage:b.Empty,nextAction:S.Plant,timerActive:!1},{stage:b.Empty,nextAction:S.Plant,timerActive:!1},{stage:b.Empty,nextAction:S.Plant,timerActive:!1}],this.gameState.inventory={},this.gameState.expansionPurchased=!1,this.initializeGardenBeds(),this.updateInventory();const r=document.getElementById("wallet-panel");r==null||r.classList.remove("open"),this.updateWalletUi(),this.saveGameState()}});h(this,"handleScroll",()=>{const e=Date.now(),t=document.documentElement,n=Math.max(1,t.scrollHeight-t.clientHeight);(window.scrollY||t.scrollTop)/n>=.95&&e-this.lastToggleTs>=this.toggleCooldownMs&&(this.toggleTheme(),this.lastToggleTs=e)});h(this,"generateWaves",()=>{const e=document.querySelector(".waves");if(!e)return;e.innerHTML="";const t=[" ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~"," - - - - - - - - - - - - - - -"," . . . . . . . . . . . . . . ."," ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~"," - - - - - - - - - - - - - - -"," . . . . . . . . . . . . . . ."],n=Math.ceil(window.innerWidth/40);for(let i=0;i<6;i++){const r=document.createElement("div");r.className="wave-line",r.textContent=t[i].repeat(n*2),e.appendChild(r)}});h(this,"animateAsciiGrass",()=>{const e=document.getElementById("ascii-grass-left"),t=document.getElementById("ascii-grass-right");if(!e||!t)return;let n=0;const i=e.textContent||"",r=t.textContent||"",c=i.split(`
`).filter(Boolean),o=r.split(`
`).filter(Boolean),l=()=>{n+=1;const u=Math.sin(n/10),w=c.map((m,p)=>{const v=Math.round(Math.sin(u+p*.6)*3),y=(m.trim()+" ").repeat(2).trim();return`${" ".repeat(Math.max(0,2+v))}${y}`}).join(`
`),f=o.map((m,p)=>{const v=Math.round(Math.sin(u+p*.6+Math.PI)*3);return`${(m.trim()+" ").repeat(2).trim()}${" ".repeat(Math.max(0,2+v))}`}).join(`
`);e.textContent=w,t.textContent=f,setTimeout(()=>requestAnimationFrame(l),120)};requestAnimationFrame(l)});h(this,"toggleTheme",()=>{const e=document.body.classList.toggle("dark-mode"),t=document.querySelector(".waves");t==null||t.classList.toggle("dark-wave",e)});var i,r,c,o,l,u,w,f;this.gameState=this.loadGameState(),this.gardenBedsContainer=document.getElementById("garden-beds"),this.welcomeModal=document.getElementById("welcome-modal"),this.startGameBtn=document.getElementById("start-game"),this.exchangeButton=document.getElementById("exchange-wheat"),this.expansionButton=document.getElementById("buy-expansion"),this.walletButton=document.getElementById("wallet-connect"),this.buyTomatoSeedBtn=document.getElementById("buy-seed-tomato"),this.buyCucumberSeedBtn=document.getElementById("buy-seed-cucumber"),this.buyHopsSeedBtn=document.getElementById("buy-seed-hops"),this.buyBrewMachineBtn=document.getElementById("buy-brewing-machine"),this.sellTomatoBtn=document.getElementById("sell-tomato"),this.sellCucumberBtn=document.getElementById("sell-cucumber"),this.buyWellButton=document.getElementById("buy-well"),this.buyFertilizerButton=document.getElementById("buy-fertilizer"),this.boundHandleScroll=this.handleScroll.bind(this),this.boundGenerateWaves=this.generateWaves.bind(this),this.boundExchangeWheat=this.exchangeWheat.bind(this),this.boundBuyExpansion=this.buyExpansion.bind(this),this.boundConnectWallet=this.connectWallet.bind(this);const e=this.buyWell.bind(this),t=this.buyFertilizer.bind(this);this.setupInventoryModule(),this.setupShopModule(),this.initializeGardenBeds(),this.updateInventory(),this.gameState.firstTime&&(this.welcomeModal.classList.add("open"),this.gameState.firstTime=!1,this.saveGameState()),this.startGameBtn.addEventListener("click",()=>{this.welcomeModal.classList.remove("open")}),this.exchangeButton.addEventListener("click",this.boundExchangeWheat),this.expansionButton.addEventListener("click",this.boundBuyExpansion),(i=this.buyWellButton)==null||i.addEventListener("click",e),(r=this.buyFertilizerButton)==null||r.addEventListener("click",t),(c=this.buyTomatoSeedBtn)==null||c.addEventListener("click",()=>this.buySeeds("seed_tomato",10)),(o=this.buyCucumberSeedBtn)==null||o.addEventListener("click",()=>this.buySeeds("seed_cucumber",12)),(l=this.buyHopsSeedBtn)==null||l.addEventListener("click",()=>this.buySeeds("seed_hops",25)),(u=this.buyBrewMachineBtn)==null||u.addEventListener("click",()=>this.buyBrewingMachine()),(w=this.sellTomatoBtn)==null||w.addEventListener("click",()=>this.sellItem("tomato",3)),(f=this.sellCucumberBtn)==null||f.addEventListener("click",()=>this.sellItem("cucumber",2)),this.walletButton.addEventListener("click",m=>{var p,v;m.preventDefault();try{const y=window.walletBridge,B=((v=(p=y==null?void 0:y.getState)==null?void 0:p.call(y))==null?void 0:v.address)??this.gameState.walletAddress,P=new CustomEvent(B?"rk:openAccount":"rk:openConnectOnly");window.dispatchEvent(P)}catch{}}),document.addEventListener("click",m=>{const p=m.target;if(!(!p||!p.closest("#wallet-disconnect"))){m.preventDefault();try{const y=new CustomEvent("rk:openConnect");window.dispatchEvent(y)}catch{}}}),window.addEventListener("scroll",this.boundHandleScroll,{passive:!0});const n=document.getElementById("sky-orb");if(n){let m=0,p=0;const v=3e3;n.addEventListener("click",()=>{var P;const y=Date.now();y-p>v&&(m=0),p=y,m++;const B=(P=n.textContent)==null?void 0:P.includes("🌙");if(!B&&m>=5){document.body.classList.add("dark-mode");const x=document.querySelector(".waves");x==null||x.classList.add("dark-wave"),n.textContent="🌙",n.classList.add("is-moon"),this.lastToggleTs=y,m=0}else if(B&&m>=5){document.body.classList.remove("dark-mode");const x=document.querySelector(".waves");x==null||x.classList.remove("dark-wave"),n.textContent="☀️",n.classList.remove("is-moon"),this.lastToggleTs=y,m=0}})}this.throttledResize=yt(this.boundGenerateWaves,200),window.addEventListener("resize",this.throttledResize,{passive:!0}),this.generateWaves(),this.animateAsciiGrass(),this.installDisconnectedGuards(),window.addEventListener("timer:end",m=>{var y;const v=(y=m.detail)==null?void 0:y.index;if(typeof v=="number")if(this.useOnChainActions)(async()=>(await this.loadGameStateOnChain(),this.saveGameState(),this.emitBedUpdate(v),this.updateInventory()))();else{const B=this.gameState.beds[v];B&&(B.timerActive=!1,B.stage===b.Seed?B.nextAction=S.Water:B.stage===b.Growing&&(B.stage=b.Ready,B.nextAction=S.Harvest),this.saveGameState(),this.emitBedUpdate(v),this.updateInventory())}}),window.addEventListener("wallet:update",()=>{var y;const m=window.walletBridge;if(!m)return;const p=(y=m.getState)==null?void 0:y.call(m),v=p==null?void 0:p.address;v&&v!==this.gameState.walletAddress&&(this.gameState.walletAddress=v,this.contract=p==null?void 0:p.contract,(async()=>(await this.loadGameStateOnChain(),this.saveGameState(),await this.updateWalletBalanceUi(),this.updateWalletUi(),this.initializeGardenBeds(),this.updateInventory(),this.attachContractEventListeners()))(),this.setupStatePolling()),!v&&this.gameState.walletAddress&&(this.disconnectWallet(),this.setupStatePolling()),this.updateWalletUi(),this.updateWalletBalanceUi(),this.updateAvailabilityBasedOnWallet()}),window.addEventListener("bed:setCrop",m=>{const p=m,{index:v,crop:y}=p.detail||{};if(typeof v!="number")return;const B=this.gameState.beds[v];B&&(B.crop=y,this.emitBedUpdate(v))}),window.addEventListener("wallet:message",m=>{var y;const v=((y=m.detail)==null?void 0:y.message)||"Wallet message";this.showToast(v)}),this.updateWalletUi(),this.updateAvailabilityBasedOnWallet(),this.setupStatePolling(),window.gameBridge={getInventory:()=>({...this.gameState.inventory}),getBed:m=>this.gameState.beds[m],performAction:m=>{const p=this.gameState.beds[m],v=`bed-${m}`;this.performAction(v,p)},disconnect:()=>this.disconnectWallet(),showToast:m=>this.showToast(m)}}deriveNextAction(e){return we(e)}async retryOperation(e,t=rn,n=500){let i=0;for(;;)try{return await e()}catch(r){if(i>=t)throw r;const c=Math.floor(Math.random()*100),o=n*2**i+c;await new Promise(l=>setTimeout(l,o)),i++}}cleanup(){var e,t,n,i;if(window.removeEventListener("scroll",this.boundHandleScroll),this.throttledResize&&(window.removeEventListener("resize",this.throttledResize),this.throttledResize=void 0),this.exchangeButton.removeEventListener("click",this.boundExchangeWheat),this.expansionButton.removeEventListener("click",this.boundBuyExpansion),this.buyWellButton&&this.buyWellButton.removeEventListener("click",this.buyWell),this.buyFertilizerButton&&this.buyFertilizerButton.removeEventListener("click",this.buyFertilizer),this.walletButton.removeEventListener("click",this.boundConnectWallet),document.documentElement.removeAttribute("style"),this.contract)try{this.onStateDeltaHandler&&((t=(e=this.contract).off)==null||t.call(e,"StateDelta",this.onStateDeltaHandler)),(i=(n=this.contract).removeAllListeners)==null||i.call(n,"StateDelta")}catch{}this.modalKeydownHandler&&(document.removeEventListener("keydown",this.modalKeydownHandler),this.modalKeydownHandler=void 0),document.querySelectorAll(".timer").forEach(r=>{const c=r;typeof c._rafId=="number"&&(cancelAnimationFrame(c._rafId),delete c._rafId)}),this.isProcessingAction=!1}emitBedUpdate(e){const t={index:e,bed:this.gameState.beds[e]},n=new CustomEvent("bed:update",{detail:t});window.dispatchEvent(n)}ensureCoins(e){return(this.gameState.inventory.coins||0)<e?(this.showCustomModal("Not enough coins"),!1):!0}addItem(e,t){this.gameState.inventory[e]||(this.gameState.inventory[e]=0),this.gameState.inventory[e]+=t}subItem(e,t){const n=this.gameState.inventory[e]||0;return n<t?!1:(this.gameState.inventory[e]=n-t,!0)}spawnBrewingMachine(){const e=document.querySelector(".farm-scene");if(!e||document.getElementById("brew-machine-container"))return;const t=document.createElement("div");t.id="brew-machine-container",t.style.position="fixed",t.style.right="8vw",t.style.bottom="110px",t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.gap="8px";const n=document.createElement("pre");n.id="brew-machine",n.style.whiteSpace="pre",n.style.fontFamily="monospace",n.style.color="var(--icon-color)",n.style.margin="0",n.textContent=["   ____  ","  |====| ","  | || | "," [| || |]","  | || | ","  |____| ","   |  |  ","  _|__|_ "].join(`
`);const i=document.createElement("button");i.id="brew-beer-machine",i.className="btn brew-btn",i.textContent="🍺 Brew Beer",i.title="Brew Beer (5 hops → 1 beer)",i.addEventListener("click",()=>this.brewBeer()),t.appendChild(n),t.appendChild(i),e.appendChild(t)}spawnAsciiWell(){const e=document.querySelector(".farm-scene");if(!e||document.getElementById("ascii-well"))return;const t=document.createElement("pre");t.id="ascii-well",t.style.position="fixed",t.style.left="8vw",t.style.bottom="160px",t.style.whiteSpace="pre",t.style.fontFamily="monospace",t.style.color="var(--well-color)",t.textContent=["    _____","   /_____\\","   |  _  |"," __|_|_|_|__","|  _  _  _  |","|_| |_| |_|_|","  (   _   )","   | | | |","   |_____|"].join(`
`),e.appendChild(t)}spawnAsciiFertilizer(){const e=document.querySelector(".farm-scene");if(!e||document.getElementById("ascii-fertilizer"))return;const t=document.createElement("pre");t.id="ascii-fertilizer",t.style.position="fixed",t.style.right="8vw",t.style.bottom="160px",t.style.whiteSpace="pre",t.style.fontFamily="monospace",t.style.color="var(--icon-color)",t.textContent=["    _________","   /  FERT  /|","  /_______ / |","  |  ____ |  |","  | |FERT||  |","  | |____||  |","  |_________|/"].join(`
`),e.appendChild(t)}attachContractEventListeners(){if(!(!this.contract||!this.gameState.walletAddress))try{this.onStateDeltaHandler=async e=>{this.gameState.walletAddress&&e.toLowerCase()===this.gameState.walletAddress.toLowerCase()&&(await this.loadGameStateOnChain(),this.saveGameState(),await this.updateWalletBalanceUi())},this.contract.on("StateDelta",this.onStateDeltaHandler)}catch{}}setupStatePolling(){var c,o;this.pollIntervalId&&(window.clearInterval(this.pollIntervalId),this.pollIntervalId=void 0);const e=window.walletBridge;if(!!!((o=(c=e==null?void 0:e.getState)==null?void 0:c.call(e))!=null&&o.address||this.gameState.walletAddress))return;const n=15e3,i=Math.floor(Math.random()*15e3),r=n+i;this.pollIntervalId=window.setInterval(()=>{this.loadGameStateOnChain().then(()=>{this.saveGameState(),this.gameState.beds.forEach((l,u)=>this.emitBedUpdate(u)),this.updateInventory()}).catch(()=>{})},r)}updateAvailabilityBasedOnWallet(){var o,l;const e=window.walletBridge,t=!!((l=(o=e==null?void 0:e.getState)==null?void 0:o.call(e))!=null&&l.address||this.gameState.walletAddress),n=document.getElementById("inventory-toggle"),i=document.getElementById("shop-toggle"),r=document.getElementById("inventory-panel"),c=document.getElementById("shop-panel");[n,i].forEach(u=>{u&&(u.setAttribute("aria-disabled",String(!t)),u.setAttribute("title",t?"":"Connect wallet to use this feature"))}),t||(r==null||r.classList.remove("open"),c==null||c.classList.remove("open"))}installDisconnectedGuards(){document.addEventListener("click",e=>{var c,o;const t=e.target;if(!t)return;const n=window.walletBridge;(o=(c=n==null?void 0:n.getState)==null?void 0:c.call(n))!=null&&o.address||this.gameState.walletAddress||!t.closest("#inventory-toggle, #shop-toggle, #exchange-wheat, #buy-expansion")||(e.preventDefault(),e.stopPropagation(),this.showToast("Connect wallet to use this feature"))},!0)}showToast(e){const t=document.querySelector(".fg-toast");t&&t.remove();const n=document.createElement("div");n.className="fg-toast",n.textContent=e,n.setAttribute("role","status"),n.setAttribute("aria-live","polite"),n.style.position="fixed",n.style.left="50%",n.style.bottom="24px",n.style.transform="translateX(-50%)",n.style.background="rgba(0,0,0,0.8)",n.style.color="#fff",n.style.padding="10px 14px",n.style.borderRadius="8px",n.style.fontSize="14px",n.style.zIndex="9999",n.style.maxWidth="90vw",n.style.textAlign="center",document.body.appendChild(n),setTimeout(()=>{n.style.transition="opacity 300ms ease",n.style.opacity="0",setTimeout(()=>n.remove(),320)},1800)}async updateWalletBalanceUi(){try{const e=document.getElementById("wallet-balance");if(!e)return;const t=window.walletBridge;if(!(t!=null&&t.getState))return;const n=t.getState(),i=n==null?void 0:n.balanceWei;if(typeof i=="bigint"){const r=10n**18n,c=Number(i/r)+Number(i%r)/Number(r);e.textContent=c.toFixed(4)}}catch{}}updateWalletUi(){var c,o;const e=document.getElementById("wallet-connect"),t=window.walletBridge,n=((o=(c=t==null?void 0:t.getState)==null?void 0:c.call(t))==null?void 0:o.address)??this.gameState.walletAddress;if(e)if(n){const l=`${n.slice(0,6)}…${n.slice(-4)}`;e.textContent=l,e.classList.add("connected"),e.setAttribute("aria-label",`Wallet ${l}`)}else e.textContent="👛",e.classList.remove("connected"),e.setAttribute("aria-label","Connect wallet");const i=document.getElementById("wallet-address");i&&(i.textContent=n??"—");const r=document.getElementById("wallet-panel");n||r==null||r.classList.remove("open")}}function hn(){const[s,e]=d.useState({}),[t,n]=d.useState(!1);d.useEffect(()=>{const r=()=>{var l,u,w;const o=(w=(u=(l=window.walletBridge)==null?void 0:l.getState)==null?void 0:u.call(l))==null?void 0:w.address;n(!!o)};r();const c=()=>r();return window.addEventListener("wallet:update",c),()=>window.removeEventListener("wallet:update",c)},[]),d.useEffect(()=>{var o,l;const r=((l=(o=window.gameBridge)==null?void 0:o.getInventory)==null?void 0:l.call(o))||{};e({...r});const c=u=>{e({...u.detail||{}})};return window.addEventListener("inventory:update",c),()=>window.removeEventListener("inventory:update",c)},[]);const i=d.useMemo(()=>Object.entries(s).filter(([,r])=>(r||0)>0),[s]);return t?i.length===0?a.jsx("p",{children:"Inventory is empty"}):a.jsx(a.Fragment,{children:i.map(([r,c])=>a.jsxs("div",{className:"inventory-item",children:[a.jsx("span",{children:wn(r)}),a.jsx("span",{children:`x${c}`})]},r))}):a.jsx("p",{children:"Connect wallet to view inventory"})}const mn=T.memo(hn);function wn(s){switch(s){case"wheat":return"🌾 Wheat";case"coins":return"💰 Coins";case"seed_tomato":return"🍅 Tomato Seeds";case"seed_cucumber":return"🥒 Cucumber Seeds";case"seed_hops":return"🌿 Hops Seeds";case"tomato":return"🍅 Tomato";case"cucumber":return"🥒 Cucumber";case"hops":return"🌿 Hops";case"beer":return"🍺 Beer";default:return s}}function fn(){const[s,e]=d.useState(!1);return d.useEffect(()=>{const t=()=>{var i,r,c;return e(!!((c=(r=(i=window.walletBridge)==null?void 0:i.getState)==null?void 0:r.call(i))!=null&&c.address))};t();const n=()=>t();return window.addEventListener("wallet:update",n),()=>window.removeEventListener("wallet:update",n)},[]),a.jsxs("div",{className:"shop-items","aria-disabled":!s,children:[a.jsx("button",{id:"exchange-wheat",className:"btn",title:s?"":"Connect wallet to use this feature",children:"Trade 10 wheat for 1 coin"}),a.jsx("button",{id:"buy-expansion",className:"btn",title:s?"":"Connect wallet to use this feature",children:"Buy expansion (100 coins)"}),a.jsx("button",{id:"buy-well",className:"btn",title:s?"":"Connect wallet to use this feature",children:"Buy Well (50 coins) — faster watering"}),a.jsx("button",{id:"buy-fertilizer",className:"btn",title:s?"":"Connect wallet to use this feature",children:"Buy Fertilizer (200 coins) — x2 harvest"}),a.jsx("hr",{}),a.jsx("button",{id:"buy-seed-tomato",className:"btn",title:s?"":"Connect wallet to use this feature",children:"Buy Tomato Seeds (10 coins)"}),a.jsx("button",{id:"buy-seed-cucumber",className:"btn",title:s?"":"Connect wallet to use this feature",children:"Buy Cucumber Seeds (12 coins)"}),a.jsx("button",{id:"buy-seed-hops",className:"btn",title:s?"":"Connect wallet to use this feature",children:"Buy Hops Seeds (25 coins)"}),a.jsx("button",{id:"buy-brewing-machine",className:"btn",title:s?"":"Connect wallet to use this feature",children:"Buy Brewing Machine (150 coins)"}),a.jsx("hr",{}),a.jsx("button",{id:"sell-tomato",className:"btn",title:s?"":"Connect wallet to use this feature",children:"Sell Tomatoes (x1 → 3 coins)"}),a.jsx("button",{id:"sell-cucumber",className:"btn",title:s?"":"Connect wallet to use this feature",children:"Sell Cucumbers (x1 → 2 coins)"})]})}function pn(){const[s,e]=d.useState(()=>{var o,l;return(l=(o=window.walletBridge)==null?void 0:o.getState)==null?void 0:l.call(o)});d.useEffect(()=>{const o=()=>{var l,u;return e((u=(l=window.walletBridge)==null?void 0:l.getState)==null?void 0:u.call(l))};return window.addEventListener("wallet:update",o),()=>{window.removeEventListener("wallet:update",o)}},[]);const t=d.useMemo(()=>{const o=s==null?void 0:s.address;return o?`${o.slice(0,6)}…${o.slice(-4)}`:"—"},[s==null?void 0:s.address]),n=d.useMemo(()=>{const o=s==null?void 0:s.balanceWei;if(typeof o=="bigint"){const l=10n**18n,u=o/l,w=o%l;return(Number(u)+Number(w)/Number(l)).toFixed(4)}return"—"},[s==null?void 0:s.balanceWei]),i=d.useMemo(()=>{const l=(window.__ENV__||{}).CONTRACT_ADDRESS||"";return!l||/^0x0{40}$/i.test(l)?"—":`${l.slice(0,6)}…${l.slice(-4)}`},[]),r=d.useMemo(()=>{const o=window.__ENV__||{},l=(o.MONAD_CHAIN_ID||"").toString(),u=l.startsWith("0x")?parseInt(l,16):parseInt(l||"0",10),w=o.MONAD_CHAIN_NAME||"Monad";return u?`${w} (${u})`:w},[]),c=d.useMemo(()=>{const o=window.__ENV__||{};try{return new URL(o.MONAD_RPC_URL||"").host}catch{return o.MONAD_RPC_URL||"—"}},[]);return a.jsxs("div",{className:"wallet-panel",id:"wallet-panel","aria-hidden":s!=null&&s.address?"false":"true",children:[a.jsxs("div",{className:"wallet-row",children:[a.jsx("span",{children:"Address:"}),a.jsx("span",{id:"wallet-address","aria-label":"Wallet address",children:t})]}),a.jsxs("div",{className:"wallet-row",children:[a.jsx("span",{children:"Balance:"}),a.jsx("span",{id:"wallet-balance","aria-label":"Wallet balance",children:n})]}),a.jsxs("div",{className:"wallet-row",children:[a.jsx("span",{children:"Chain:"}),a.jsx("span",{"aria-label":"Chain info",children:r})]}),a.jsxs("div",{className:"wallet-row",children:[a.jsx("span",{children:"RPC:"}),a.jsx("span",{"aria-label":"RPC host",children:c})]}),a.jsxs("div",{className:"wallet-row",children:[a.jsx("span",{children:"Contract:"}),a.jsx("span",{"aria-label":"Contract address",children:i})]}),a.jsxs("div",{className:"wallet-actions",children:[a.jsx("button",{id:"wallet-disconnect","aria-label":"Disconnect or switch wallet",onClick:o=>{o.preventDefault();try{window.dispatchEvent(new CustomEvent("rk:openConnect"))}catch{}},children:"Wallet"}),a.jsx("button",{id:"wallet-logout","aria-label":"Logout session",onClick:async o=>{o.preventDefault();try{await fetch("/siwe/logout",{method:"POST",credentials:"include"});const l=new CustomEvent("wallet:message",{detail:{level:"info",message:"Logged out"}});window.dispatchEvent(l)}catch{}},children:"Logout"})]})]})}function vn(){const{isConnected:s}=Te(),{openConnectModal:e}=Me(),{openAccountModal:t}=Le(),n=d.useCallback(()=>{s?t==null||t():e==null||e()},[s,e,t]);return a.jsx("button",{className:"wallet-connect",id:"wallet-connect","aria-label":"Connect wallet",onClick:n,children:"👛"})}function gn(){return a.jsxs(a.Fragment,{children:[a.jsx("button",{className:"inventory-toggle",id:"inventory-toggle","aria-label":"Open inventory",children:"🎒"}),a.jsxs("div",{className:"inventory-panel",id:"inventory-panel",children:[a.jsx("h2",{className:"inventory-title",children:"Inventory"}),a.jsx("div",{className:"inventory-items",id:"inventory-list",children:a.jsx(mn,{})})]}),a.jsx(vn,{}),a.jsx(pn,{}),a.jsx("button",{className:"shop-toggle",id:"shop-toggle","aria-label":"Open shop",children:"🏪"}),a.jsxs("div",{className:"shop-panel",id:"shop-panel",children:[a.jsx("h2",{className:"shop-title",children:"Shop"}),a.jsx(fn,{})]}),a.jsx("div",{className:"custom-modal",id:"custom-modal",role:"dialog","aria-modal":"true","aria-labelledby":"custom-modal-message","aria-hidden":"true",children:a.jsxs("div",{className:"custom-modal-content",id:"custom-modal-content",role:"document",children:[a.jsx("p",{id:"custom-modal-message"}),a.jsx("button",{className:"custom-modal-button",id:"custom-modal-button","aria-label":"Close dialog",children:"OK"})]})}),a.jsx("div",{className:"game-container",children:a.jsxs("div",{className:"farm-scene",children:[a.jsx("button",{className:"sky-orb",id:"sky-orb","aria-label":"Sun",children:"☀️"}),a.jsxs("div",{className:"clouds","aria-hidden":"true",children:[a.jsx("div",{className:"cloud cloud--1",children:"☁️"}),a.jsx("div",{className:"cloud cloud--2",children:"☁️"}),a.jsx("div",{className:"cloud cloud--3",children:"☁️"}),a.jsx("div",{className:"cloud cloud--4",children:"☁️"})]}),a.jsx("div",{className:"garden-beds",id:"garden-beds"}),a.jsx("pre",{id:"ascii-grass-left","aria-hidden":"true",style:{position:"fixed",bottom:120,left:0,width:"calc(50vw - 180px)",textAlign:"left",color:"var(--grass-color)",fontFamily:"monospace",whiteSpace:"pre",pointerEvents:"none",zIndex:0},children:`
~  ~   ~~   ~  ~~   ~   ~ ~    ~~    ~  ~~   ~
  ~~  ~   ~~   ~  ~~   ~    ~~   ~  ~~   ~  ~ 
~   ~~    ~  ~~   ~   ~~  ~   ~~   ~   ~~   ~ 
  ~   ~  ~~   ~  ~~   ~   ~   ~  ~~   ~  ~~   
`}),a.jsx("pre",{id:"ascii-grass-right","aria-hidden":"true",style:{position:"fixed",bottom:120,right:0,width:"calc(50vw - 180px)",textAlign:"right",color:"var(--grass-color)",fontFamily:"monospace",whiteSpace:"pre",pointerEvents:"none",zIndex:0},children:`
~  ~   ~~   ~  ~~   ~   ~ ~    ~~    ~  ~~   ~
  ~~  ~   ~~   ~  ~~   ~    ~~   ~  ~~   ~  ~ 
~   ~~    ~  ~~   ~   ~~  ~   ~~   ~   ~~   ~ 
  ~   ~  ~~   ~  ~~   ~   ~   ~  ~~   ~  ~~   
`})]})}),a.jsxs("div",{className:"trees","aria-hidden":"true",children:[a.jsxs("div",{className:"tree",children:[a.jsx("pre",{className:"canopy breeze-1",children:`   cce*88oo
 C8O8*8Q8P*0b o8oo
d0B*9*O8P*UOpug09*D
C0*900*89PBC0PL*S0BB*
 Cgg*bU8*U0*00d*U0dcb
   60*U   /p   gc*U*dpP
     \\//    /d*uUP*
      \\/////`}),a.jsx("pre",{className:"trunk",children:`       |||||
       |||||
  ....//||||\\....\\../\\//.....`})]}),a.jsxs("div",{className:"tree",children:[a.jsx("pre",{className:"canopy breeze-2",children:`    cce*88oo
  C8O8*8Q8P*0b o8oo
 dOB*9*O8P*UOpug09*D
  Cgg*bU8*U0*00d*U0dcb
    6O*U  /p  gc*U*dpP
      \\//  /d*uUP*
        \\////`}),a.jsx("pre",{className:"trunk",children:`         |||||
         |||||
 ...././||||\\..../\\/....`})]}),a.jsxs("div",{className:"tree",children:[a.jsx("pre",{className:"canopy breeze-3",children:`     cce*88oo
   C8O8*8Q8P*0b o8oo
  dOB*9*O8P*UOpug09*D
   CO*900*89PBC0PL*S0BB*
     6O*U  /p  gc*U*dpP
        \\//  /d*uUP*
          \\///`}),a.jsx("pre",{className:"trunk",children:`          ||||
          ||||
  ...//||||\\..;'/\\/..../`})]}),a.jsxs("div",{className:"tree",children:[a.jsx("pre",{className:"canopy breeze-1",children:`      *o88oo
    C8Q8*8P*0b oo
   d0B*9*08*UOpg09*D
    Cg*bU8*U0*0d*U0db
      6O*U /p gc*U*dp
        \\// /d*uU
          \\///`}),a.jsx("pre",{className:"trunk",children:`        ||||
        ||||
   ...//||||\\..../\\/..`})]}),a.jsxs("div",{className:"tree",children:[a.jsx("pre",{className:"canopy breeze-2",children:`       cce*8oo
     C8O8*Q8P*b o8o
   dOB*9*O8P*UOpug*
     Cgg*bU8*U0*0db
       6O*U /p gc*U
         \\// /d*
          \\//`}),a.jsx("pre",{className:"trunk",children:`         |||
         |||
   ..//||||\\.../\\/..`})]})]}),a.jsx("div",{id:"expansion-reserve",style:{position:"fixed",right:"4vw",top:"20vh",width:200,height:120,pointerEvents:"none"},"aria-hidden":"true"}),a.jsx("div",{className:"waves"}),a.jsx("div",{className:"page-extension"}),a.jsx("div",{className:"modal",id:"welcome-modal",children:a.jsxs("div",{className:"modal-content",children:[a.jsx("h2",{children:"Welcome to ASCII Farm!"}),a.jsx("p",{children:"Take care of your plants, harvest the crops and enjoy!"}),a.jsx("p",{children:"Stages of growth:"}),a.jsx("p",{children:"🟫 → 🌱 → 🌽 → 🌾"}),a.jsx("p",{children:"Each action takes 8 hours of real time."}),a.jsx("button",{className:"btn",id:"start-game",children:"Start game"})]})})]})}function X(){return!1}class yn extends T.Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0,message:e instanceof Error?e.message:String(e)}}componentDidCatch(e,t){const n=me(i=>(i.setTag("error_boundary","web3"),i.setLevel("error"),i.setContext("error_info",{componentStack:t.componentStack,errorBoundary:"Web3ErrorBoundary"}),wt(e)));this.setState({eventId:n})}render(){if(this.state.hasError){const e=X();return a.jsxs("div",{className:"error-container",children:[a.jsx("h2",{children:"Что-то пошло не так"}),e?a.jsx("p",{children:this.state.message}):a.jsx("p",{children:"Произошла техническая ошибка. Пожалуйста, перезагрузите страницу или попробуйте позже."}),a.jsxs("div",{className:"error-actions",children:[a.jsx("button",{onClick:()=>this.setState({hasError:!1,message:void 0,eventId:void 0}),children:"Попробовать снова"}),e&&this.state.eventId&&a.jsx("button",{onClick:()=>mt({eventId:this.state.eventId}),style:{marginLeft:"10px"},children:"Сообщить об ошибке"})]}),e&&a.jsxs("details",{style:{marginTop:"10px",fontSize:"12px"},children:[a.jsx("summary",{children:"Техническая информация (только для разработчиков)"}),a.jsx("pre",{children:this.state.message}),this.state.eventId&&a.jsxs("p",{children:["Sentry Event ID: ",this.state.eventId]})]})]})}return this.props.children}}const xe={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_APP_VERSION:"0.0.0"};var Ee={};function ae(s){if(typeof process<"u"&&typeof Ee<"u"){const e=Ee[s];if(typeof e<"u")return e}try{if(typeof import.meta<"u"&&xe)return xe[s]}catch{}}function Ce(){return ae("MODE")||ae("NODE_ENV")||"development"}function Sn(){const s=ae("VITE_SENTRY_DSN");s&&ft({dsn:s,environment:Ce(),integrations:[],tracesSampleRate:Ce()==="production"?.1:1,beforeSend(e,t){const n=t.originalException;return n&&typeof n=="object"&&"code"in n&&(n.code===4001||n.code===-32002)?null:e},release:ae("VITE_APP_VERSION")||"unknown",initialScope:{tags:{component:"farm-game-web3"}}})}function ne(s,e){Re({category:"wallet",message:s,level:s.includes("failed")?"error":"info",data:e}),s==="connect_failed"&&me(t=>{t.setTag("event_type","wallet_connection"),t.setLevel("warning"),Oe(`Wallet connection failed: ${(e==null?void 0:e.error)||"Unknown error"}`)})}function bn(s,e,t){Re({category:"rpc",message:`RPC call to ${s}`,level:t?"info":"error",data:{endpoint:s,duration:e,success:t}}),e>5e3&&me(n=>{n.setTag("performance_issue","slow_rpc"),n.setTag("rpc_endpoint",s),n.setLevel("warning"),Oe(`Slow RPC response: ${s} took ${e}ms`)})}class xn{constructor(){h(this,"metrics",new Map);h(this,"healthCheckInterval");this.startHealthCheck()}async monitorRpcCall(e,t,n){const i=performance.now();let r=!1;try{const c=await n();return r=!0,this.recordSuccess(e,performance.now()-i),c}catch(c){throw this.recordError(e,performance.now()-i,c),c}finally{bn(e,performance.now()-i,r)}}recordSuccess(e,t){const n=this.getOrCreateMetrics(e);n.requestCount++,n.totalTime+=t,n.averageTime=n.totalTime/n.requestCount,n.lastSuccess=Date.now()}recordError(e,t,n){const i=this.getOrCreateMetrics(e);i.requestCount++,i.errorCount++,i.totalTime+=t,i.averageTime=i.totalTime/i.requestCount,i.lastError=n instanceof Error?n.message:String(n)}getOrCreateMetrics(e){return this.metrics.has(e)||this.metrics.set(e,{endpoint:e,requestCount:0,totalTime:0,errorCount:0,averageTime:0}),this.metrics.get(e)}getHealthStatus(){const e=Date.now(),t=Array.from(this.metrics.entries()).map(([n,i])=>{const r=i.requestCount>0?i.errorCount/i.requestCount:0,c=r<.1&&i.averageTime<5e3,o=i.lastSuccess?(e-i.lastSuccess)/(1e3*60):null;return{endpoint:n,isHealthy:c,errorRate:Math.round(r*100),averageTime:Math.round(i.averageTime),requestCount:i.requestCount,lastError:i.lastError,lastSeenMinutes:o?Math.round(o):null}});return{timestamp:e,endpoints:t,overallHealth:t.length===0||t.every(n=>n.isHealthy)}}startHealthCheck(){this.healthCheckInterval=window.setInterval(()=>{const e=this.getHealthStatus(),t=e.endpoints.filter(n=>!n.isHealthy);t.length>0&&window.dispatchEvent(new CustomEvent("rpc:unhealthy",{detail:{endpoints:t}}));try{localStorage.setItem("rpc_metrics",JSON.stringify(e))}catch{}},3e4)}destroy(){this.healthCheckInterval&&clearInterval(this.healthCheckInterval)}reset(){this.metrics.clear()}getEndpointMetrics(e){return this.metrics.get(e)}}const ue=new xn;function ze(){const[s,e]=T.useState(ue.getHealthStatus());return T.useEffect(()=>{const t=()=>e(ue.getHealthStatus());t();const n=()=>t();window.addEventListener("rpc:unhealthy",n);const i=setInterval(t,1e4);return()=>{window.removeEventListener("rpc:unhealthy",n),clearInterval(i)}},[]),s}typeof window<"u"&&X()&&(window.__rpcMonitor=ue);function En({isVisible:s=!1,onToggle:e}){const t=ze(),[n,i]=d.useState({attempts:0,successes:0,failures:0,lastFailure:null});if(d.useEffect(()=>{const c=JSON.parse(localStorage.getItem("wallet_stats")||'{"attempts":0,"successes":0,"failures":0,"lastFailure":null}');i(c);const o=l=>{const{type:u,error:w}=l.detail||{},f={...c};u==="connect_attempt"?f.attempts++:u==="connect_success"?f.successes++:u==="connect_failed"&&(f.failures++,f.lastFailure=w||"Unknown error"),i(f),localStorage.setItem("wallet_stats",JSON.stringify(f))};return window.addEventListener("wallet:stats",o),()=>window.removeEventListener("wallet:stats",o)},[]),!X())return null;if(!s)return a.jsx("button",{onClick:()=>e==null?void 0:e(!0),style:{position:"fixed",bottom:"20px",right:"20px",background:t.overallHealth?"#22c55e":"#ef4444",color:"white",border:"none",borderRadius:"50%",width:"48px",height:"48px",cursor:"pointer",fontSize:"20px",zIndex:1e3,opacity:.7},title:"Developer Monitoring Dashboard",children:"🔧"});const r=n.attempts>0?Math.round(n.successes/n.attempts*100):0;return a.jsxs("div",{style:{position:"fixed",bottom:"20px",right:"20px",background:"rgba(0, 0, 0, 0.9)",color:"white",padding:"16px",borderRadius:"8px",minWidth:"300px",maxWidth:"400px",fontSize:"12px",zIndex:1e3,boxShadow:"0 4px 12px rgba(0, 0, 0, 0.3)"},children:[a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"12px"},children:[a.jsx("h3",{style:{margin:0,fontSize:"14px"},children:"Developer Dashboard"}),a.jsx("button",{onClick:()=>e==null?void 0:e(!1),style:{background:"none",border:"none",color:"white",cursor:"pointer"},children:"✕"})]}),a.jsx("div",{style:{marginBottom:"16px"},children:a.jsxs("div",{style:{display:"flex",alignItems:"center",padding:"8px",background:t.overallHealth?"rgba(34, 197, 94, 0.2)":"rgba(239, 68, 68, 0.2)",borderRadius:"4px"},children:[a.jsx("span",{style:{marginRight:"8px",fontSize:"16px"},children:t.overallHealth?"✅":"❌"}),a.jsxs("span",{children:["System ",t.overallHealth?"Healthy":"Issues Detected"]})]})}),a.jsxs("div",{style:{marginBottom:"16px"},children:[a.jsx("h4",{style:{margin:"0 0 8px 0",fontSize:"13px"},children:"Wallet Connections"}),a.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"8px"},children:[a.jsxs("div",{children:[a.jsxs("div",{children:["Success Rate: ",a.jsxs("strong",{children:[r,"%"]})]}),a.jsxs("div",{style:{fontSize:"10px",opacity:.8},children:[n.successes,"/",n.attempts," attempts"]})]}),a.jsxs("div",{children:[a.jsxs("div",{children:["Failures: ",a.jsx("strong",{children:n.failures})]}),n.lastFailure&&a.jsxs("div",{style:{fontSize:"10px",opacity:.8,color:"#ef4444"},children:["Last: ",n.lastFailure.slice(0,30),"..."]})]})]})]}),a.jsxs("div",{children:[a.jsx("h4",{style:{margin:"0 0 8px 0",fontSize:"13px"},children:"RPC Endpoints"}),t.endpoints.length===0?a.jsx("div",{style:{opacity:.6},children:"No RPC calls yet"}):t.endpoints.map((c,o)=>a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"4px 0",borderBottom:o<t.endpoints.length-1?"1px solid rgba(255,255,255,0.1)":"none"},children:[a.jsxs("div",{style:{flex:1},children:[a.jsx("div",{style:{fontSize:"11px",fontWeight:"bold"},children:c.endpoint.replace("https://","").split("/")[0]}),a.jsxs("div",{style:{fontSize:"10px",opacity:.8},children:[c.requestCount," calls • ",c.averageTime,"ms avg",c.lastSeenMinutes&&` • ${c.lastSeenMinutes}m ago`]})]}),a.jsx("div",{style:{width:"8px",height:"8px",borderRadius:"50%",background:c.isHealthy?"#22c55e":"#ef4444"}})]},o))]}),!1]})}function Cn(){const[s,e]=d.useState(!1);d.useEffect(()=>{if(!X())return;const n=i=>{i.ctrlKey&&i.shiftKey&&i.key==="D"&&e(r=>!r)};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[]);const t=ze();return d.useEffect(()=>{X()&&!t.overallHealth&&t.endpoints.some(n=>!n.isHealthy)&&e(!0)},[t]),{isVisible:s,setIsVisible:e,health:t}}class Bn extends T.Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(){return{hasError:!0}}componentDidCatch(e,t){}render(){return this.state.hasError?a.jsxs("div",{className:"error-container",children:[a.jsx("h2",{children:"Something went wrong."}),a.jsx("button",{onClick:()=>this.setState({hasError:!1}),children:"Try again"})]}):this.props.children}}function In(){const s=d.useRef(!1),e=d.useRef(null),{isVisible:t,setIsVisible:n}=Cn();return d.useEffect(()=>(s.current||(e.current=dn(),s.current=!0),()=>{e.current&&e.current.cleanup()}),[]),a.jsx(Bn,{children:a.jsxs(yn,{children:[a.jsx(gn,{}),a.jsx(En,{isVisible:t,onToggle:n})]})})}function he(s){return s?typeof s.request=="function":!1}let J=null;const Fe="wallet:preferred:provider";function _n(){try{return localStorage.getItem(Fe)}catch{return null}}function An(s){try{localStorage.setItem(Fe,s)}catch{}}async function jn(s=200){if(J)return J;J=[];const e=[],t=i=>{const r=i;r!=null&&r.detail&&e.push(r.detail)};try{window.addEventListener("eip6963:announceProvider",t),window.dispatchEvent(new Event("eip6963:requestProvider"))}catch{}await new Promise(i=>setTimeout(i,s));try{window.removeEventListener("eip6963:announceProvider",t)}catch{}const n=new Map;for(const i of e)n.set(i.info.uuid,i);return J=Array.from(n.values()),J}async function Be(){const s=await jn();if(s.length===0){const i=window.ethereum;return i&&he(i)?i:void 0}if(s.length===1)return s[0].provider;const e=_n(),t=e?s.find(i=>i.info.uuid===e):void 0;if(t)return t.provider;const n=new Error("Multiple wallet providers detected");throw n.name="ProviderSelectionRequired",n.providers=s.map(i=>i.info),n}function Nn(){if(!L)return"0x0";const s=L.toString();return s.startsWith("0x")?s.toLowerCase():`0x${parseInt(s,10).toString(16)}`}async function Ie(s){const e=Nn();try{await s.request({method:"wallet_switchEthereumChain",params:[{chainId:e}]});return}catch(t){const n=t;if((n==null?void 0:n.code)===4902){await s.request({method:"wallet_addEthereumChain",params:[{chainId:e,chainName:Ue||"Monad Testnet",rpcUrls:[He].filter(Boolean),nativeCurrency:{name:"MON",symbol:"MON",decimals:18}}]});return}throw t}}function _e(s){if(!s)return{message:"Unknown error"};const e=s,t=e.code,n=e.name,i=e.data,r=typeof e.message=="string"&&e.message.length>0?e.message:"Unknown error";return{code:t,name:n,message:r,data:i}}function Tn(s){switch(s.code){case 4001:return"Операция отменена пользователем";case-32002:return"Запрос к кошельку уже ожидает. Откройте кошелёк.";case 4100:return"Операция не авторизована в кошельке.";case 4900:return"Кошелёк отключён от всех сетей.";case 4902:return"Запрошенная сеть отсутствует в кошельке.";case-32602:return"Неверные параметры запроса к RPC.";case-32603:return"Внутренняя ошибка RPC. Повторите попытку позже.";default:if(typeof s.message=="string"){if(/Already processing/.test(s.message))return"Запрос к кошельку уже ожидает. Откройте кошелёк.";if(/User rejected/i.test(s.message))return"Операция отменена пользователем"}return s.message||"Произошла ошибка кошелька"}}function Mn(s=16){const e=new Uint8Array(s);return crypto.getRandomValues(e),Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}function Ln(s){const{domain:e,address:t,uri:n,chainId:i,statement:r,nonce:c}=s,o=new Date().toISOString(),l=new Date(Date.now()+6e4).toISOString();return`${e} wants you to sign in with your Ethereum account:
${t}

${r}

URI: ${n}
Version: 1
Chain ID: ${i}
Nonce: ${c}
Issued At: ${o}
Expiration Time: ${l}`}async function Pn(){try{const s=await fetch("/siwe/nonce",{method:"GET",headers:{accept:"application/json"}});if(!s.ok)return;const e=await s.json();return typeof(e==null?void 0:e.nonce)=="string"&&e.nonce.length>0?e.nonce:void 0}catch{return}}async function kn(s){try{return(await fetch("/siwe/verify",{method:"POST",headers:{"content-type":"application/json",accept:"application/json"},body:JSON.stringify(s),credentials:"include"})).ok}catch{return!1}}async function Ae(){try{const s=await fetch("/me",{method:"GET",headers:{accept:"application/json"},credentials:"include"});return s.ok?await s.json():{ok:!1}}catch{return null}}async function ce(){try{await fetch("/siwe/logout",{method:"POST",credentials:"include"})}catch{}}const Rn=d.createContext(void 0);function On({children:s}){const[e,t]=d.useState("disconnected"),[n,i]=d.useState(void 0),[r,c]=d.useState(void 0),[o,l]=d.useState(void 0),[u,w]=d.useState(void 0),[f,m]=d.useState(void 0),[p,v]=d.useState(void 0),[y,B]=d.useState(void 0),P=d.useRef(void 0),x=d.useRef(null),I=d.useCallback(async()=>{},[]),$=d.useCallback(async()=>{if(e==="connecting"||e==="connected")return x.current??Promise.resolve();B(void 0),t("connecting"),ne("connect_attempt");const g=(async()=>{var _;try{const E=await Be();if(!he(E)||!E)throw new Error("Wallet provider not available");const C=E;P.current=C;const[A]=await C.request({method:"eth_requestAccounts"});await Ie(C);const N=await C.request({method:"eth_chainId"}),z=Number(typeof N=="string"?parseInt(N,16):N),k=await Pn()||Mn(),R=Ln({domain:window.location.host,address:A,uri:window.location.origin,chainId:z,statement:"Sign in to FarmGame on Monad",nonce:k}),D=await at(F,{message:R,account:A});if(await kn({address:A,message:R,signature:D}).catch(()=>!1)){const H=await Ae().catch(()=>null);if(!(H!=null&&H.ok)||((_=H==null?void 0:H.address)==null?void 0:_.toLowerCase())!==A.toLowerCase())throw new Error("SIWE session mismatch")}i(A),w(void 0),l(void 0),m(void 0);const O=await C.request({method:"eth_chainId"});c(typeof O=="string"?O:String(O)),t("connected"),ne("connect_success",{walletType:C!=null&&C.isMetaMask?"metamask":"unknown",chainId:typeof O=="string"?O:String(O)}),await I()}catch(E){const C=_e(E),A=Tn(C);if(B(A),t("error"),ne("connect_failed",{error:A}),(E==null?void 0:E.name)==="ProviderSelectionRequired"&&(E!=null&&E.providers))try{const N=new CustomEvent("wallet:providers",{detail:{providers:E.providers}});window.dispatchEvent(N)}catch{}try{const N=new CustomEvent("wallet:message",{detail:{level:C.code===-32002?"info":C.code===4001?"warning":"error",message:A,code:C.code}});window.dispatchEvent(N)}catch{}}finally{x.current=null}})();return x.current=g,g},[I,e]),M=d.useCallback(()=>{ce(),t("disconnected"),i(void 0),l(void 0),w(void 0),m(void 0),v(void 0),c(void 0),B(void 0),ne("disconnect")},[]),G=d.useCallback(async()=>{const g=P.current??window.ethereum;if(!g)return;await Ie(g);const _=await g.request({method:"eth_chainId"});c(typeof _=="string"?_:String(_))},[]);d.useEffect(()=>{let g;(async()=>{var _;try{const E=await Be();if(!he(E))return;g=E,P.current=g}catch{return}if(g)try{const E=await g.request({method:"eth_accounts"});if(E&&E.length>0){t("connecting"),i(E[0]),w(void 0),l(void 0),m(void 0);const C=await g.request({method:"eth_chainId"}),A=typeof C=="string"?C.toLowerCase():String(C);c(A);const N=((_=L==null?void 0:L.toString)==null?void 0:_.call(L))||"",z=N.startsWith("0x")?N.toLowerCase():`0x${parseInt(N||"0",10).toString(16)}`;if(z&&A!==z){t("disconnected"),i(void 0),l(void 0),w(void 0),m(void 0),v(void 0);try{const k=new CustomEvent("wallet:message",{detail:{level:"warning",message:"Переключите сеть на Monad чтобы продолжить."}});window.dispatchEvent(k)}catch{}return}t("connected"),await I()}}catch(E){_e(E)}})()},[I]),d.useEffect(()=>{const g=E=>{var A;const C=E;(A=C==null?void 0:C.detail)!=null&&A.uuid&&An(C.detail.uuid)},_=()=>{try{const E=new CustomEvent("rk:openConnect");window.dispatchEvent(E)}catch{}};return window.addEventListener("wallet:pickProvider",g),window.addEventListener("wallet:openConnect",_),()=>{window.removeEventListener("wallet:pickProvider",g),window.removeEventListener("wallet:openConnect",_)}},[]),d.useEffect(()=>{var A,N,z;const g=P.current;if(!g)return;const _=k=>{const R=k;if(!R||R.length===0)ce(),M();else{const D=R[0];(async()=>{var O;const W=await Ae();(!(W!=null&&W.ok)||((O=W.address)==null?void 0:O.toLowerCase())!==D.toLowerCase())&&await ce().catch(()=>{})})(),i(D),I()}},E=k=>{var O;const R=typeof k=="string"?k.toLowerCase():String(k);c(R);const D=((O=L==null?void 0:L.toString)==null?void 0:O.call(L))||"",W=D.startsWith("0x")?D.toLowerCase():`0x${parseInt(D||"0",10).toString(16)}`;if(W&&R!==W){try{const H=new CustomEvent("wallet:message",{detail:{level:"warning",message:"Эта dApp работает только в сети Monad. Переключите сеть."}});window.dispatchEvent(H)}catch{}M();return}I()},C=()=>{M()};return(A=g.on)==null||A.call(g,"accountsChanged",_),(N=g.on)==null||N.call(g,"chainChanged",E),(z=g.on)==null||z.call(g,"disconnect",C),()=>{var k,R,D;(k=g.removeListener)==null||k.call(g,"accountsChanged",_),(R=g.removeListener)==null||R.call(g,"chainChanged",E),(D=g.removeListener)==null||D.call(g,"disconnect",C)}},[M,I]);const K=d.useMemo(()=>({status:e,address:n,chainId:r,provider:o,signer:u,contract:f,balanceWei:p,error:y,connect:$,disconnect:M,refreshBalance:I,switchNetwork:G}),[e,n,r,o,u,f,p,y,$,M,I,G]);return d.useEffect(()=>{window.walletBridge={connect:$,disconnect:M,switchNetwork:G,refreshBalance:I,getState:()=>({status:e,address:n,chainId:r,provider:o,signer:u,contract:f,balanceWei:p,error:y})};const g=new CustomEvent("wallet:update");window.dispatchEvent(g)},[e,n,r,o,u,f,p,y,$,M,I,G]),a.jsx(Rn.Provider,{value:K,children:s})}function Dn(){const{address:s,status:e}=Te(),t=it(),{openConnectModal:n}=Me(),{openAccountModal:i}=Le();return d.useEffect(()=>{window.walletBridge={...window.walletBridge,getState:()=>({address:s,chainId:t})};try{const r=new CustomEvent("wallet:update");window.dispatchEvent(r)}catch{}},[s,t,e]),d.useEffect(()=>{const r=()=>{s?i==null||i():n==null||n()},c=()=>n==null?void 0:n(),o=()=>i==null?void 0:i();return window.addEventListener("rk:openConnect",r),window.addEventListener("rk:openConnectOnly",c),window.addEventListener("rk:openAccount",o),()=>{window.removeEventListener("rk:openConnect",r),window.removeEventListener("rk:openConnectOnly",c),window.removeEventListener("rk:openAccount",o)}},[s,n,i]),null}function Wn(){const[s,e]=d.useState(null),t=d.useMemo(()=>Array.isArray(s)&&s.length>1,[s]);return d.useEffect(()=>{const n=i=>{var c;const r=i;(c=r==null?void 0:r.detail)!=null&&c.providers&&e(r.detail.providers)};return window.addEventListener("wallet:providers",n),()=>window.removeEventListener("wallet:providers",n)},[]),t?a.jsx("div",{className:"provider-picker-overlay",role:"dialog","aria-modal":"true",children:a.jsxs("div",{className:"provider-picker",children:[a.jsx("h3",{children:"Выберите кошелёк"}),a.jsx("ul",{children:s.map(n=>a.jsx("li",{children:a.jsxs("button",{onClick:()=>{try{const i=new CustomEvent("wallet:pickProvider",{detail:{uuid:n.uuid}});window.dispatchEvent(i)}catch{}e(null)},children:[a.jsx("img",{src:n.icon,alt:"",width:20,height:20}),a.jsx("span",{children:n.name})]})},n.uuid))}),a.jsx("button",{className:"close",onClick:()=>e(null),children:"Отмена"})]})}):null}function Hn(){const[s,e]=d.useState([]);return d.useEffect(()=>{let t=1;const n=r=>e(c=>[...c,{...r,id:t++}]),i=r=>{var u,w;const c=r,o=((u=c.detail)==null?void 0:u.level)||"info",l=((w=c.detail)==null?void 0:w.message)||"";l&&(n({level:o,message:l}),setTimeout(()=>e(f=>f.slice(1)),3500))};return window.addEventListener("wallet:message",i),()=>window.removeEventListener("wallet:message",i)},[]),s.length===0?null:a.jsx("div",{className:"toast-container","aria-live":"polite","aria-atomic":"true",children:s.map(t=>a.jsx("div",{className:`toast ${t.level}`,children:t.message},t.id))})}const je={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_APP_VERSION:"0.0.0"};try{window.__ENV__={CONTRACT_ADDRESS:void 0,MONAD_RPC_URL:void 0,MONAD_CHAIN_ID:void 0,MONAD_CHAIN_NAME:void 0}}catch{}Sn();const Ne=document.getElementById("root");Ne&&De.createRoot(Ne).render(a.jsx(T.StrictMode,{children:a.jsx(Pt,{children:a.jsxs(On,{children:[a.jsx(Dn,{}),a.jsx(Wn,{}),a.jsx(Hn,{}),a.jsx(In,{})]})})}));["VITE_CONTRACT_ADDRESS"].filter(e=>!je[e]||String(je[e]).trim()==="");const qn=Object.freeze(Object.defineProperty({__proto__:null,default:lt},Symbol.toStringTag,{value:"Module"}));export{qn as e};
